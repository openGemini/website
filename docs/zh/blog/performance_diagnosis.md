---
blog: true
title: 3分钟教会你：数据库性能诊断
pubDate: '2024-03-20'
author: 周益剑
abstract: 数据库是现代企业运营中不可或缺的一部分，它们存储着企业的核心数据和信息。然而，数据库性能问题是一个常见的挑战，它们可能导致系统崩溃、速度缓慢或数据丢失。因此，数据库性能诊断是必要的，以保证数据库的正常运行和高效性能
cover: /images/cover/3min_zh.png
recommend: 0
category: 技术解读
tag: 性能诊断
---

## 性能指标简介

当谈到系统性能时，TPS、时延和吞吐量是三个最常用的性能指标。以下是关于这些指标的一些基本信息：

**TPS（Transactions per Second）**：每秒钟可以处理的事务数量。事务可以是任何与网络应用程序相关的操作，例如数据库查询、文件上传或下载等。TPS 是一个重要的性能指标，因为它直接影响到应用程序的响应时间。如果 TPS 较低，那么用户将需要等待更长时间才能完成他们的操作。

**时延**：指完成一个操作所需的时间。时延可以分为几个不同的部分，包括传输延迟、处理延迟和排队延迟。传输延迟指的是数据从一个地方到另一个地方所需的时间。处理延迟是指处理数据所需的时间，例如执行数据库查询或计算。排队延迟是指等待处理的数据在队列中等待的时间。时延对于网络应用程序的性能至关重要，因为它直接影响到用户的体验。如果时延较高，那么用户将需要等待更长时间才能完成他们的操作。

**并发量**：同时访问系统的用户数量，是衡量系统并发处理能力的重要指标。

**吞吐量**：单位时间内传输的数据量。吞吐量是网络应用程序的另一个关键性能指标，因为它直接影响到应用程序的响应时间。如果吞吐量较低，那么用户将需要等待更长时间才能完成他们的操作。

**计算公式：TPS = 并发数 / 平均响应时间**

根据公式可知，在系统负载较轻的情况下，TPS和并发量通常是正相关的，即并发量越高，TPS也就越高。 

但是当系统负载达到一定程度时，由于系统资源有限，TPS和并发量就会出现反比关系，即并发量越高，TPS反而越低。此时，时延也会随着并发量的增加而增加，因为系统需要更多的时间来处理请求。



## 诊断步骤

1. 收集性能数据：收集数据库的性能数据，包括TPS、并发数、平均响应时延、CPU、内存、磁盘、网络等方面的数据，以及数据库的日志文件、错误日志等信息。
2. 分析性能数据：根据收集到的性能数据，分析数据库的性能瓶颈。
3. 确认性能瓶颈：通过分析性能数据，确认数据库的性能瓶颈，确定需要解决的问题。 
4. 优化数据库：根据确认的性能瓶颈，制定相应的优化方案，比如增加硬件资源、优化SQL语句、调整数据库配置参数等。
5. 测试优化效果：对数据库进行优化后，需要进行测试验证，确保性能得到了提升。
6. 监控数据库：对数据库进行持续的监控，及时发现并解决新的性能问题，确保数据库的稳定性和高性能运行。

## openGemini 性能诊断案例

1. 性能问题：xx客户通过自研应用程序消费kafka，写入到openGemini，反馈kafka数据积压，消费速度跟不上生产速度。

2. 性能诊断：当遇到该问题时，我们采集了并发、时延、TPS等关键性能指标数据，发现并发、时延、CPU利用率均很低，该机器CPU逻辑核有32核，平均并发为2，说明数据库实际写入量远小于处理能力上限制。因此我们得出初步结论，瓶颈不在数据库，而应该在客户端侧。

   ![](/images/docs_img/performance-1.png)

   ![](/images/docs_img/performance-2.png)

   根据文章介绍的计算公式，TPS = 并发/时延，可以很好的知道，在时延稳定的前提下，TPS随着并发数的增加而增加。

2. **性能问题解决**：通知客户增加应用程序写入openGemini的并发数，大幅提升了TPS，写入吞吐增加，积压快速消除，消费跟上，最终顺利解决了客户性能问题。
